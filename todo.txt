CALENDAR CONVERTER CLI: Product Requirements Document (Todo Format)
Tech Stack: Go CLI (Cobra), ICS parsing (icalendar), AppleScript bridge, REST API clients, Homebrew distribution
Philosophy: CLI-first, file-first with optional API mode, universal calendar/task interchange with conflict resolution
================================================================================

--- PHASE 1: CORE DATA MODEL & ICS ENGINE ---

--- PHASE 2: APP-SPECIFIC PARSERS (FILE-BASED) ---

(A) Implement Things 3 SQLite reader that queries ~/Library/Group Containers/JLMPQHK86H.com.culturedcode.ThingsMac/Things Database.thingsdatabase/main.sqlite for tasks, projects, areas, checklists +things
(A) Implement Things 3 JSON-URL writer that constructs things:///add-json payloads from CalendarItem structs, chunked to respect URL length limits +things
(A) Implement Things 3 AppleScript writer as fallback for bulk import when URL scheme payload exceeds size limits +things
(A) Write tests for Things 3 SQLite reader using a fixture database with: inbox task, project with tasks, area, task with checklist, completed task, task with tags and deadline +things
(A) Implement OmniFocus TaskPaper parser that reads OmniFocus TaskPaper export format mapping projects, tasks, tags, defer/due dates, notes to CalendarItem +omnifocus
(A) Implement OmniFocus TaskPaper writer that serializes CalendarItem structs to OmniFocus-compatible TaskPaper format with @tags, @defer(), @due() annotations +omnifocus
(A) Write tests for OmniFocus TaskPaper parser covering: project with nested tasks, task with defer and due dates, task with tags, completed task, task with note +omnifocus

--- PHASE 3: APPLE BRIDGE (SORTED 3 PATHWAY) ---

(A) Implement AppleScript executor helper that runs osascript commands from Go and parses structured output +apple
(A) Implement Apple Reminders writer via AppleScript that creates reminders with title, notes, due date, priority, list assignment from CalendarItem +apple
(A) Implement Apple Reminders reader via AppleScript that fetches all reminders across lists and maps to CalendarItem structs +apple
(A) Implement Apple Calendar writer via AppleScript that creates calendar events with title, start/end time, notes, location, recurrence from CalendarItem +apple
(A) Implement Apple Calendar reader via AppleScript that fetches events from specified calendars within a date range and maps to CalendarItem structs +apple
(A) Implement Sorted 3 import orchestrator that routes tasks to Apple Reminders and events to Apple Calendar, then logs instructions for user to sync Sorted 3 +apple
(A) Implement Sorted 3 export orchestrator that reads from Apple Calendar and Apple Reminders, filters by a user-specified Sorted 3 list/calendar name +apple
(A) Implement Apple bridge permission checker that verifies Automation/Accessibility permissions and provides osascript error recovery guidance +apple
(A) Write integration tests for Apple Reminders read/write cycle using a test reminder list that is created and cleaned up +apple
(A) Write integration tests for Apple Calendar read/write cycle using a test calendar that is created and cleaned up +apple

--- PHASE 4: API-BASED CONNECTORS ---

(B) Implement OAuth2 PKCE flow helper for API-based connectors with token storage in ~/.config/calconv/tokens.json +api
(B) Implement TickTick REST API client with OAuth2 auth supporting: list tasks, create task, update task, delete task +api
(B) Implement TickTick API-to-CalendarItem mapper using API JSON response fields (id, title, content, desc, startDate, dueDate, priority, status, tags, items) +api
(B) Implement TickTick CalendarItem-to-API mapper for creating/updating tasks via API with field validation +api
(B) Implement Todoist REST API client with OAuth2 auth supporting: get tasks, create task, update task, close task, get projects +api
(B) Implement Todoist Sync API client for incremental sync using sync tokens for efficient bulk reads +api
(B) Implement Todoist API-to-CalendarItem mapper handling natural language dates, label IDs, section/project hierarchy +api
(B) Implement Google Calendar API client with OAuth2 auth supporting: list events, insert event, update event, delete event, list calendars +api
(B) Implement Google Calendar API-to-CalendarItem mapper handling attendees, conferencing, extended properties +api
(B) Implement Microsoft Graph API client with OAuth2 auth supporting: list events, create event, update event for Outlook calendars +api
(B) Implement Notion API client with Bearer token auth supporting: query database, create page, update page properties +api
(B) Implement Notion API-to-CalendarItem mapper with user-configurable property-to-field mapping via config +api
(B) Write integration tests for each API client using recorded HTTP fixtures (go-vcr or httptest) to avoid live API calls in CI +api

--- PHASE 5: CONFLICT RESOLUTION ENGINE ---

(A) Implement duplicate detector that matches CalendarItems by UID, or by (Title + StartTime/DueDate) fuzzy match when UID is absent +conflict
(A) Implement interactive conflict resolver that presents side-by-side diff of conflicting items in terminal and prompts user to pick source/target/merge/skip +conflict
(A) Implement field-level merge mode where user can cherry-pick individual fields (title from source, date from target) during conflict resolution +conflict
(A) Implement priority mapping conflict handler that shows source priority value, target app scale, and asks user to confirm or override mapped value +conflict
(A) Implement data loss warning system that detects unsupported fields in target format (e.g., subtasks â†’ Google Calendar) and prompts user: flatten to description / drop / abort +conflict
(A) Implement tag/label mapping resolver that detects unmapped tags and prompts user to create new tags in target, map to existing, or drop +conflict
(A) Implement recurrence downgrade handler: when RRULE fails to map to target, prompt user to accept flattened instances with date range or skip +conflict
(A) Implement batch conflict mode with --auto-resolve flag supporting strategies: prefer-source, prefer-target, skip-conflicts, fail-on-conflict +conflict
(A) Implement conflict resolution log that writes all decisions to a JSON file at ~/.config/calconv/conflict-log.json for audit +conflict
(A) Write tests for duplicate detector covering: exact UID match, fuzzy title+date match, no match, multiple candidates +conflict
(A) Write tests for data loss warning covering: subtask flattening, reminder drop, priority unmappable, tag mismatch +conflict

--- PHASE 6: CLI INTERFACE ---

(A) Initialize Go module with cobra CLI framework, root command with --version, --verbose, --config flags +cli
(A) Implement `calconv convert` command with positional args: source-format, target-format, input-file, output-file +cli
(A) Implement `calconv convert` auto-detection of source format from file extension (.ics, .csv, .json, .sqlite, .taskpaper) with --from flag override +cli
(A) Implement `calconv convert` --from and --to flags accepting: ticktick, todoist, gcal, outlook, apple-cal, apple-reminders, sorted3, things, notion, trello, asana, omnifocus, ics +cli
(A) Implement `calconv list-formats` command that prints all supported source and target formats with capabilities matrix (events/tasks/recurring/subtasks) +cli
(A) Implement `calconv validate` command that parses input file, reports warnings/errors, and previews item count and field coverage without converting +cli
(A) Implement `calconv diff` command that compares two calendar files and shows added/removed/modified items +cli
(A) Implement `calconv sync` command that uses API connectors to pull from source app, diff with local, push to target app with conflict resolution +cli
(A) Implement `calconv config` command for managing settings in ~/.config/calconv/config.toml: default formats, API credentials path, conflict strategy, timezone preference +cli
(A) Implement `calconv auth` command with subcommands (login, logout, status) for managing OAuth tokens per service +cli
(A) Implement progress bar using a terminal UI library for long-running conversions and API syncs +cli
(A) Implement --dry-run flag on convert and sync commands that shows planned changes without writing output +cli
(A) Implement --quiet flag that suppresses all output except errors and final summary +cli
(A) Implement JSON and plain-text output modes via --output-format flag for scripting integration +cli
(A) Implement stdin/stdout piping support: read from stdin when input-file is "-", write to stdout when output-file is "-" +cli
(A) Write CLI integration tests using Go's exec.Command to verify: convert happy path, format auto-detection, --dry-run output, piped I/O, invalid input error messages +cli

--- PHASE 7: CONFIGURATION & SETTINGS ---

(A) Implement TOML config file loader from ~/.config/calconv/config.toml with defaults for all settings +config
(A) Implement config option: preferred_mode = "file" | "api" controlling default connector selection +config
(A) Implement config option: default_timezone for normalizing events without explicit timezone +config
(A) Implement config option: conflict_strategy = "ask" | "prefer-source" | "prefer-target" | "skip" | "fail" +config
(A) Implement config option: priority_map as custom per-app priority mapping overrides +config
(A) Implement config option: tag_map as custom per-app tag/label name mappings +config
(A) Implement config section: [api.ticktick], [api.todoist], [api.google], [api.microsoft], [api.notion] for client_id, client_secret, redirect_uri +config
(A) Implement config validation on load that reports unknown keys and type mismatches with line numbers +config
(A) Implement XDG base directory compliance: config in $XDG_CONFIG_HOME/calconv/, cache in $XDG_CACHE_HOME/calconv/, data in $XDG_DATA_HOME/calconv/ +config
(A) Write tests for config loader covering: missing file with defaults, partial config merge, invalid TOML syntax error, unknown key warning +config

--- PHASE 8: ERROR HANDLING & EDGE CASES ---

(A) Implement structured error types: ParseError, ValidationError, ConflictError, APIError, PermissionError with source file/line context +errors
(A) Implement charset detection for CSV files (UTF-8, UTF-16, Latin-1) with automatic transcoding to UTF-8 +errors
(A) Implement date/time parser that handles ambiguous formats (MM/DD/YYYY vs DD/MM/YYYY) by inferring from locale or prompting user +errors
(A) Implement graceful handling of oversized files with streaming parser for ICS and CSV instead of loading entire file into memory +errors
(A) Implement partial failure mode: continue converting valid items when individual items fail, collect errors, report summary at end +errors
(A) Implement retry logic with exponential backoff for API calls with configurable max retries +errors
(A) Implement signal handler for SIGINT/SIGTERM that cleanly writes partial output and conflict log before exit +errors
(A) Write tests for error handling covering: malformed CSV row, invalid ICS property, API 429 rate limit, interrupted conversion resume +errors

--- PHASE 9: BUILD & DISTRIBUTION ---

(A) Create Makefile with targets: build, test, lint (golangci-lint), fmt, vet, coverage, install +build
(A) Create goreleaser config for cross-platform binary builds (darwin-amd64, darwin-arm64, linux-amd64, linux-arm64, windows-amd64) +build
(A) Create Homebrew formula in a tap repo (homebrew-calconv) with binary download, sha256 verification, and test block +build
(A) Create GitHub Actions CI workflow: lint, test, build on push; goreleaser on tag push for releases +build
(A) Create GitHub Actions workflow job that runs Apple bridge integration tests on macOS runner only +build
(A) Implement `calconv --version` output including git commit hash and build date via ldflags injection +build
